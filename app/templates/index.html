<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°ç«¯ LLM RAG æ•´åˆä»‹é¢</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a; --primary-text: #f0f0f0; --secondary-text: #a0a0a0;
            --surface-color: #242424; --border-color: #3a3a3a; --accent-color: #8257E5;
            --accent-hover: #9466FF; --danger-color: #e53935; --danger-hover: #c62828;
            --success-color: #4CAF50; --info-color: #2196F3;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            font-size: 16px;
            line-height: 1.6;
            margin: 0; 
            background-color: var(--bg-color); 
            color: var(--primary-text); 
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        h1 { text-align: center; margin-bottom: 2rem; font-weight: 600; color: #f9f9f9; }
        .main-layout { display: flex; gap: 2rem; align-items: flex-start; }
        .left-panel { flex: 3; display: flex; flex-direction: column; }
        .right-panel { flex: 1; min-width: 350px; position: sticky; top: 2rem;}
        .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 0 0.5rem; margin-bottom: 1rem; }
        .panel-header h2 { margin: 0; font-size: 1.2em; color: var(--primary-text); }
        .danger-btn { background-color: transparent; border: 1px solid var(--danger-color); color: var(--danger-color); padding: 8px 12px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; font-size: 0.9em; }
        .danger-btn:hover { background-color: rgba(229, 57, 53, 0.1); }
        .danger-btn svg { stroke: var(--danger-color); }
        .panel-tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 1.5rem; }
        .panel-tab-button { padding: 0.8rem 1rem; cursor: pointer; background: none; border: none; color: var(--secondary-text); font-size: 1rem; transition: all 0.2s; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .panel-tab-button.active { color: var(--accent-color); border-bottom-color: var(--accent-color); font-weight: 600;}
        .panel-tab-content { display: none; }
        .panel-tab-content.active { display: block; }
        
        .card {
            background-color: var(--surface-color);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .card-header {
            padding: 1rem 1.25rem;
            background-color: rgba(255,255,255,0.03);
            border-bottom: 1px solid var(--border-color);
            font-size: 1em;
            font-weight: 600;
            margin: 0;
        }
        .card-body {
            padding: 1.25rem;
        }
        .card-body.no-padding { padding: 0; }
        
        #model-selector { width: 100%; padding: 8px; background-color: #2c2c2c; color: var(--primary-text); border: 1px solid var(--border-color); border-radius: 5px; font-size: 1em; }
        #model-status { margin-top: 0.5rem; display: block; font-size: 0.9em; color: var(--secondary-text); transition: color 0.3s;}
        
        .toggle-switch-container {
            display: flex;
            align-items: center;
            padding: 0.9rem 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .toggle-switch-container:last-child { border-bottom: none; }
        .toggle-input { opacity: 0; width: 0; height: 0; position: absolute; }
        .toggle-label { cursor: pointer; display: flex; align-items: center; width: 100%; }
        .slider { position: relative; display: inline-block; width: 50px; height: 28px; background-color: #4a4a4a; transition: .4s; border-radius: 28px; flex-shrink: 0; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        .toggle-text { margin-left: 12px; color: var(--primary-text); }
        .toggle-input:checked + .toggle-label .slider { background-color: var(--success-color); }
        .toggle-input:checked + .toggle-label .slider:before { transform: translateX(22px); }
        .toggle-input:focus + .toggle-label .slider { box-shadow: 0 0 1px var(--success-color); }
        #chat-container { display: flex; flex-direction: column; height: 80vh; background-color: var(--surface-color); border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color);}
        #chat-box { flex-grow: 1; padding: 1rem; overflow-y: auto; }
        
        .message { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .message::before { content: ''; display: block; width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; font-weight: bold; text-align: center; line-height: 36px; font-size: 1em; }
        .bot-message::before { background-color: var(--accent-color); content: 'AI'; }
        .user-message { flex-direction: row-reverse; }
        .user-message::before { background-color: #4a4a4a; content: 'U'; }
        
        .message-wrapper { display: flex; flex-direction: column; max-width: 80%; }
        .user-message .message-wrapper { align-items: flex-end; }
        .bot-message .message-wrapper { align-items: flex-start; }
        .message .content { padding: 0.75rem 1rem; border-radius: 12px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        .user-message .content { background-color: var(--accent-color); color: white; border-bottom-right-radius: 2px; }
        .bot-message .content { background-color: #363636; color: var(--primary-text); border-bottom-left-radius: 2px; min-height: 1.6em;}
        
        .sources-container { display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
        .sources-container h4 { margin: 0; padding-right: 0.5rem; font-size: 0.9em; color: var(--secondary-text); }
        .sources-container h4::before { content: 'ğŸ“š'; margin-right: 0.5rem; }
        .source-item { background-color: rgba(255, 255, 255, 0.08); padding: 0.4rem 0.8rem; border-radius: 15px; font-size: 0.8em; cursor: pointer; border: 1px solid var(--border-color); display: inline-block; transition: all 0.2s; }
        .source-item:hover { background-color: rgba(255, 255, 255, 0.15); border-color: var(--info-color); }
        .source-content-container { display: none; margin-top: 0.5rem; padding: 0.5rem; background-color: rgba(0,0,0,0.3); border-radius: 5px; width: 100%; box-sizing: border-box;}
        .source-content { border-left: 2px solid #555; padding: 0.5rem; margin-bottom: 0.5rem; white-space: pre-wrap; max-height: 150px; overflow-y: auto; color: var(--secondary-text); }
        .source-content:last-child { margin-bottom: 0; }
        mark { background-color: #e6e676; color: #000; padding: 0 2px; border-radius: 2px; }
        
        #chat-form { display: flex; padding: 1rem; border-top: 1px solid var(--border-color); gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.75rem; border: 1px solid #444; border-radius: 5px; background-color: #2c2c2c; color: white; font-size: 1rem; resize: none; max-height: 150px; overflow-y: auto; }
        #chat-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(130, 87, 229, 0.2); }
        #chat-submit { padding: 0.5rem; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border: none; border-radius: 5px; background-color: var(--accent-color); color: white; cursor: pointer; flex-shrink: 0; }
        #chat-submit:hover { background-color: var(--accent-hover); }
        #chat-submit:disabled { background-color: #555; cursor: not-allowed; }
        
        .upload-container { text-align: center; }
        #upload-status { margin-top: 1rem; font-size: 0.9em; }
        .search-box { width: 100%; box-sizing: border-box; padding: 10px; margin-bottom: 1rem; background-color: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 5px; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.9em; }
        th { background-color: #1f1f1f; }
        td { word-break: break-word; white-space: pre-wrap; }
        .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
        .delete-btn:hover { background-color: var(--danger-hover); }
        .loading { text-align: center; padding: 20px; font-size: 18px; }
        .record-id { font-family: monospace; color: #888; font-size: 12px; }
        .thinking-block { margin-top: 0.5rem; background-color: rgba(255, 255, 255, 0.05); border-left: 3px solid var(--accent-color); padding: 0.5rem 1rem; border-radius: 4px; }
        .toggle-think { background: none; border: none; color: var(--secondary-text); cursor: pointer; padding: 0; font-size: 0.9em; text-decoration: underline; }
        .thinking-content { display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed var(--border-color); white-space: pre-wrap; color: #ccc; }
        .thinking-content.visible { display: block; }
        .bot-message .content h1, .bot-message .content h2, .bot-message .content h3 { margin-top: 1em; margin-bottom: 0.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
        .bot-message .content ul, .bot-message .content ol { padding-left: 2em; }
        .bot-message .content pre { background-color: rgba(0,0,0,0.3); padding: 1em; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; }
        .bot-message .content code { background-color: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        
        #pagination-controls { display: flex; justify-content: center; align-items: center; margin-top: 1.5rem; gap: 0.5rem; }
        .pagination-btn { background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--primary-text); padding: 8px 14px; border-radius: 5px; cursor: pointer; transition: all 0.2s; }
        .pagination-btn:hover:not(:disabled) { background-color: var(--accent-color); border-color: var(--accent-color); }
        .pagination-btn:disabled { color: #666; cursor: not-allowed; }
        #page-info { font-size: 0.9em; color: var(--secondary-text); }
    </style>
</head>
<body>
    <div class="container">
        <h1>æœ¬åœ°ç«¯ LLM RAG æ•´åˆä»‹é¢</h1>
        <div class="main-layout">
            <div class="left-panel">
                <div class="panel-header">
                    <h2>å°è©±è¦–çª—</h2>
                    <button id="clear-chat-btn" class="danger-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        <span>æ¸…é™¤å°è©±</span>
                    </button>
                </div>
                <div id="chat-container">
                    <div id="chat-box">
                        <div class="message bot-message">
                            <div class="message-wrapper">
                                <div class="content">ä½ å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ RAG åŠ©ç†ã€‚æ‚¨å¯ä»¥å¾å³å´é¢æ¿é¸æ“‡æ¨¡å‹ã€è¨­å®šåŠŸèƒ½æˆ–ä¸Šå‚³æ–‡ä»¶ä¾†é–‹å§‹å°è©±ã€‚</div>
								<div class="content">Hello! I am your RAG assistant. You can select a model, configure features, or upload documents from the right panel to start a conversation.</div>
                            </div>
                        </div>
                    </div>
                    <div id="chat-form">
                        <textarea id="chat-input" placeholder="åœ¨é€™è£¡è¼¸å…¥æ‚¨çš„å•é¡Œ... (Shift+Enter æ›è¡Œ)" rows="1" onkeydown="handleEnter(event)"></textarea>
                        <button type="button" id="chat-submit" onclick="sendMessage()">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="right-panel">
                <div class="panel-tabs">
                    <button class="panel-tab-button active" onclick="openPanelTab(event, 'settings')">è¨­å®š</button>
                    <button class="panel-tab-button" onclick="openPanelTab(event, 'db-manager')">è³‡æ–™åº«ç®¡ç†</button>
                </div>
                <div id="settings" class="panel-tab-content">
                    <div class="card">
                        <h3 class="card-header">æ¨¡å‹èˆ‡åŠŸèƒ½</h3>
                        <div class="card-body">
                            <label for="model-selector">é¸å–æ¨¡å‹:</label>
                            <select id="model-selector">
                                <option value="">æ­£åœ¨è¼‰å…¥...</option>
                            </select>
                            <span id="model-status"></span>
                        </div>
                        <div class="card-body no-padding">
                            <div class="toggle-switch-container">
                                <input type="checkbox" id="scraper-toggle" class="toggle-input" checked>
                                <label for="scraper-toggle" class="toggle-label">
                                    <span class="slider"></span>
                                    <span class="toggle-text">å•Ÿç”¨ç¶²é çˆ¬èŸ²</span>
                                </label>
                            </div>
                            <div class="toggle-switch-container">
                                <input type="checkbox" id="wikipedia-toggle" class="toggle-input" checked>
                                 <label for="wikipedia-toggle" class="toggle-label">
                                    <span class="slider"></span>
                                    <span class="toggle-text">å•Ÿç”¨ç¶­åŸºç™¾ç§‘</span>
                                </label>
                            </div>
                            <div class="toggle-switch-container">
                                 <input type="checkbox" id="history-toggle" class="toggle-input" checked>
                                 <label for="history-toggle" class="toggle-label">
                                    <span class="slider"></span>
                                    <span class="toggle-text">å•Ÿç”¨æ­·å²å°è©±</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="db-manager" class="panel-tab-content">
                    <div class="card">
                        <h3 class="card-header">æ–‡ä»¶ä¸Šå‚³</h3>
                        <div class="card-body upload-container">
                            <label for="file-upload" class="upload-label">ä¸Šå‚³æ–°æ–‡ä»¶åˆ°çŸ¥è­˜åº«</label>
                            <input id="file-upload" type="file" accept=".pdf,.doc,.docx,.txt,.md,.html,.pptx">
                            <button id="upload-btn">ä¸Šå‚³ä¸¦è™•ç†</button>
                            <div id="upload-status"></div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-header">çŸ¥è­˜åº«ç®¡ç†</h3>
                        <div class="card-body">
                            <input type="text" id="searchBox" class="search-box" placeholder="å³æ™‚æœç´¢ç•¶å‰é é¢å…§å®¹...">
                            <p id="recordCount">ç¸½å…±æœ‰ 0 ç­†ç´€éŒ„</p>
                            <div id="loading" class="loading">æ­£åœ¨è¼‰å…¥è³‡æ–™...</div>
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width: 20%;">ID</th>
                                        <th style="width: 55%;">å…§å®¹</th>
                                        <th style="width: 15%;">ä¾†æº</th>
                                        <th style="width: 10%;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="recordTableBody"></tbody>
                            </table>
                            <div id="pagination-controls"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Vars ---
        let chatBox, chatInput, submitButton, modelSelector, modelStatus, clearChatBtn;
        let historyToggle, wikipediaToggle, scraperToggle;
        let uploadBtn, fileInput, uploadStatus;
        let allRecords = [];
        let currentPage = 1;
		let searchDebounceTimer;

        // --- Init Function ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get all elements
            chatBox = document.getElementById('chat-box');
            chatInput = document.getElementById('chat-input');
            submitButton = document.getElementById('chat-submit');
            modelSelector = document.getElementById('model-selector');
            modelStatus = document.getElementById('model-status');
            clearChatBtn = document.getElementById('clear-chat-btn');
            historyToggle = document.getElementById('history-toggle');
            wikipediaToggle = document.getElementById('wikipedia-toggle');
            scraperToggle = document.getElementById('scraper-toggle');
            uploadBtn = document.getElementById('upload-btn');
            fileInput = document.getElementById('file-upload');
            uploadStatus = document.getElementById('upload-status');
            
            // Add event listeners
            historyToggle.addEventListener('change', () => handleToggleChange(historyToggle, '/api/set_history'));
            wikipediaToggle.addEventListener('change', () => handleToggleChange(wikipediaToggle, '/api/set_wikipedia'));
            scraperToggle.addEventListener('change', () => handleToggleChange(scraperToggle, '/api/set_scraper'));
            modelSelector.addEventListener('change', handleModelChange);
            clearChatBtn.addEventListener('click', handleClearChat);
            uploadBtn.addEventListener('click', handleFileUpload);
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = (chatInput.scrollHeight) + 'px';
            });

            // Initialize
            loadModelsAndSettings();
            openPanelTab({ currentTarget: document.querySelector('.panel-tab-button') }, 'settings');
        });

        async function loadModelsAndSettings() {
            try {
                const response = await fetch('/api/models');
                if (!response.ok) throw new Error(`ç„¡æ³•ç²å–æ¨¡å‹: ${response.statusText}`);
                const data = await response.json();
                modelSelector.innerHTML = '';
                if (!data.models || data.models.length === 0) {
                    modelSelector.innerHTML = '<option>ç„¡å¯ç”¨æ¨¡å‹</option>';
                    modelSelector.disabled = true;
                    submitButton.disabled = true;
                } else {
                    data.models.forEach(model => {
                        const option = new Option(model, model);
                        if (model === data.current_model) {
                            option.selected = true;
                            modelStatus.textContent = `ç•¶å‰: ${data.current_model.split(':')[0]}`;
                        }
                        modelSelector.appendChild(option);
                    });
                    modelSelector.disabled = false;
                    submitButton.disabled = false;
                }
                historyToggle.checked = data.history_enabled;
                wikipediaToggle.checked = data.wikipedia_enabled;
                scraperToggle.checked = data.scraper_enabled;
            } catch (error) {
                console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
                modelStatus.textContent = "èˆ‡å¾Œç«¯é€£ç·šå¤±æ•—";
                modelStatus.style.color = "var(--danger-color)";
                submitButton.disabled = true;
            }
        }
        async function handleToggleChange(toggleElement, apiUrl) {
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled: toggleElement.checked }) });
                if (!response.ok) throw new Error('ä¼ºæœå™¨åˆ‡æ›å¤±æ•—');
            } catch (error) {
                console.error(`åˆ‡æ›å¤±æ•—:`, error);
                toggleElement.checked = !toggleElement.checked;
            }
        }
        async function handleModelChange(event) {
            const selectedModel = event.target.value;
            modelStatus.textContent = `åˆ‡æ›ä¸­...`;
            try {
                const response = await fetch('/api/set_model', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: selectedModel }) });
                const result = await response.json();
                if (response.ok && result.success) {
                    modelStatus.textContent = `ç•¶å‰: ${selectedModel.split(':')[0]} âœ…`;
                    modelStatus.style.color = "var(--success-color)";
                } else { throw new Error(result.error || 'æœªçŸ¥éŒ¯èª¤'); }
            } catch (error) {
                modelStatus.textContent = `åˆ‡æ›å¤±æ•—`;
                modelStatus.style.color = "var(--danger-color)";
            }
            setTimeout(() => {
                 modelStatus.textContent = `ç•¶å‰: ${modelSelector.value.split(':')[0]}`;
                 modelStatus.style.color = "var(--secondary-text)";
            }, 4000);
        }
        function handleClearChat() {
            if (confirm('æ‚¨ç¢ºå®šè¦æ¸…é™¤ç›®å‰è¦–çª—ä¸­çš„å°è©±å—ï¼Ÿ')) {
                chatBox.innerHTML = `<div class="message bot-message"><div class="message-wrapper"><div class="content">ä½ å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ RAG åŠ©ç†ã€‚æ‚¨å¯ä»¥å¾å³å´é¢æ¿é¸æ“‡æ¨¡å‹ã€è¨­å®šåŠŸèƒ½æˆ–ä¸Šå‚³æ–‡ä»¶ä¾†é–‹å§‹å°è©±ã€‚</div></div></div>`;
            }
        }
        async function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) { uploadStatus.textContent = "è«‹å…ˆé¸å–ä¸€å€‹æª”æ¡ˆã€‚"; return; }
            const formData = new FormData();
            formData.append('file', file);
            uploadStatus.textContent = `æ­£åœ¨ä¸Šå‚³ ${file.name}...`;
            uploadBtn.disabled = true;
            try {
                const response = await fetch('/api/upload_document', { method: 'POST', body: formData });
                const result = await response.json();
                if (response.ok && result.success) {
                    uploadStatus.textContent = result.message;
                    uploadStatus.style.color = "var(--success-color)";
                    if (document.getElementById('db-manager').classList.contains('active')) fetchRecords();
                } else { throw new Error(result.error || 'ä¸Šå‚³å¤±æ•—'); }
            } catch (error) {
                uploadStatus.textContent = `éŒ¯èª¤: ${error.message}`;
                uploadStatus.style.color = "var(--danger-color)";
            } finally {
                uploadBtn.disabled = false;
                fileInput.value = '';
            }
        }
        function openPanelTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("panel-tab-content");
            for (i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
            tablinks = document.getElementsByClassName("panel-tab-button");
            for (i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            if (tabName === 'db-manager') {
                if (!window.dbManagerInitialized) { initDbManager(); window.dbManagerInitialized = true; } 
                else { fetchRecords(); }
            }
        }
        function appendMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper';
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            if (sender === 'user') {
                contentDiv.textContent = text;
            }
            messageWrapper.appendChild(contentDiv);
            messageDiv.appendChild(messageWrapper);
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return messageWrapper;
        }
        function appendSources(messageWrapper, sources, userQuestion) {
            let sourcesContainer = messageWrapper.querySelector('.sources-container');
            if (sourcesContainer) return;
            sourcesContainer = document.createElement('div');
            sourcesContainer.className = 'sources-container';
            const title = document.createElement('h4');
            sourcesContainer.appendChild(title);
            const groupedSources = {};
            sources.forEach(source => {
                let displayName = source.metadata.source.split(/[\\/]/).pop();
                if (displayName === 'conversation' && source.metadata.timestamp) {
                    displayName = `æ­·å²å°è©± (${source.metadata.timestamp})`;
                }
                if (!groupedSources[displayName]) groupedSources[displayName] = [];
                groupedSources[displayName].push(source.page_content);
            });
            const keywords = userQuestion.split(/\s+/).filter(word => word.length > 2 && !/^[a-zA-Z0-9-_]+$/.test(word));
            const regex = keywords.length > 0 ? new RegExp(`(${keywords.join('|')})`, 'gi') : null;
            for (const [displayName, contents] of Object.entries(groupedSources)) {
                const sourceItem = document.createElement('div');
                sourceItem.className = 'source-item';
                sourceItem.textContent = `ä¾†æº: ${displayName}`;
                sourceItem.addEventListener('click', () => {
                    let contentContainer = sourceItem.querySelector('.source-content-container');
                    if (!contentContainer) {
                        contentContainer = document.createElement('div');
                        contentContainer.className = 'source-content-container';
                        contents.forEach(content => {
                            const contentDiv = document.createElement('div');
                            contentDiv.className = 'source-content';
                            let highlightedContent = escapeHtml(content);
                            if (regex) highlightedContent = highlightedContent.replace(regex, `<mark>$1</mark>`);
                            contentDiv.innerHTML = highlightedContent;
                            contentContainer.appendChild(contentDiv);
                        });
                        sourceItem.appendChild(contentContainer);
                    }
                    contentContainer.style.display = contentContainer.style.display === 'block' ? 'none' : 'block';
                });
                sourcesContainer.appendChild(sourceItem);
            }
            messageWrapper.insertBefore(sourcesContainer, messageWrapper.firstChild);
        }
        async function sendMessage() {
  const question = chatInput.value.trim();
        if (!question) return;

        appendMessage(question, 'user');
        chatInput.value = '';
        chatInput.style.height = 'auto';
        submitButton.disabled = true;

        const botMessageWrapper = appendMessage('', 'bot');
        const thinkBlock = document.createElement('div');
        thinkBlock.className = 'thinking-block';
        thinkBlock.style.display = 'none';
        thinkBlock.innerHTML = `<button class='toggle-think' onclick='toggleThink(this)'>é¡¯ç¤º/éš±è—æ€è€ƒéç¨‹</button><div class='thinking-content'></div>`;
        
        const botContentDiv = botMessageWrapper.querySelector('.content');
        botMessageWrapper.insertBefore(thinkBlock, botContentDiv);
        const thinkContentDiv = thinkBlock.querySelector('.thinking-content');

        let fullBotResponse = '';
        let animationFrameId = null;

        const render = () => {
            const thinkStartIndex = fullBotResponse.indexOf('<think>');
            const thinkEndIndex = fullBotResponse.indexOf('</think>'); 

            let thinkText = '';
            let answerText = '';

            if (thinkStartIndex !== -1) {
                thinkBlock.style.display = 'block';
                if (thinkEndIndex !== -1 && thinkEndIndex > thinkStartIndex) {
                    thinkText = fullBotResponse.substring(thinkStartIndex + 7, thinkEndIndex);
                    answerText = fullBotResponse.substring(thinkEndIndex + 8);
                } else {
                    thinkText = fullBotResponse.substring(thinkStartIndex + 7);
                }
            } else {
                answerText = fullBotResponse;
            }
            
            thinkContentDiv.textContent = thinkText.trimStart();
            botContentDiv.textContent = answerText.trimStart();
            
            chatBox.scrollTop = chatBox.scrollHeight;
            animationFrameId = null;
        };

            const appendError = (message) => {
                const errorP = document.createElement('p');
                errorP.style.color = 'var(--danger-color)';
                errorP.textContent = `[éŒ¯èª¤]ï¼š${message}`;
                botContentDiv.appendChild(errorP);
                submitButton.disabled = false;
            };
        try {
            const eventSource = new EventSource(`/ask?question=${encodeURIComponent(question)}`);
            
            eventSource.onmessage = function(event) {
                if (event.data === '[DONE]') {
                    eventSource.close();
                    submitButton.disabled = false;
                    
                    const finalText = botContentDiv.textContent;
                    if (finalText) {
                        botContentDiv.innerHTML = marked.parse(finalText);
                    }
                    
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        render();
                    }
                    return;
                }

                const data = JSON.parse(event.data);
                
                if (data.type === 'sources') {
                    appendSources(botMessageWrapper, data.data, question);
                } else if (data.type === 'content' && data.content) {
                    fullBotResponse += data.content;
                    if (!animationFrameId) {
                        animationFrameId = requestAnimationFrame(render);
                    }
                } else if (data.type === 'error' || data.error) {
                        appendError(data.error);
                    eventSource.close();
                }
            };

            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                    appendError("ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ã€‚");
                eventSource.close();
                submitButton.disabled = false;
            };
        } catch (error) {
            console.error('Error:', error);
                appendError("ç™¼ç”ŸæœªçŸ¥çš„å‰ç«¯éŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹ä¸»æ§å°ã€‚");
        }
    }
        function toggleThink(buttonElement) {
            const content = buttonElement.nextElementSibling;
            if (content) content.classList.toggle('visible');
        }
        function handleEnter(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function initDbManager() {
            fetchRecords(1);
			const searchBox = document.getElementById('searchBox');
            // ä½¿ç”¨ debounce æŠ€è¡“ä¾†å„ªåŒ–æœå°‹é«”é©—
            searchBox.addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            // åœ¨ä½¿ç”¨è€…åœæ­¢è¼¸å…¥ 300 æ¯«ç§’å¾Œï¼Œæ‰è§¸ç™¼æœå°‹
            searchDebounceTimer = setTimeout(() => {
            fetchRecords(1); // æ¯æ¬¡æœå°‹éƒ½å¾ç¬¬ä¸€é é–‹å§‹
        }, 300);
    });
        }
        
        async function fetchRecords(page = 1) {
            const loadingDiv = document.getElementById('loading');
            const tableBody = document.getElementById('recordTableBody');
            const searchBox = document.getElementById('searchBox');
            const perPage = 50;
			const searchQuery = searchBox.value.trim();
            loadingDiv.style.display = 'block';
            tableBody.innerHTML = '';
            
            try {
            const response = await fetch(`/api/records?page=${page}&per_page=${perPage}&query=${encodeURIComponent(searchQuery)}`);
                if (!response.ok) throw new Error('ç„¡æ³•ç²å–è³‡æ–™');      
                 const data = await response.json();      
                 allRecords = data.records; // allRecords ç¾åœ¨åªç”¨æ–¼å®¢æˆ¶ç«¯é«˜äº®ï¼Œä¸å†ç”¨æ–¼éæ¿¾
                 currentPage = data.current_page;   
                 renderTable(allRecords, searchQuery); // å‚³å…¥ searchQuery ç”¨æ–¼é«˜äº®
                 renderPagination(data.total_pages, data.current_page);
                 document.getElementById('recordCount').innerText = `ç¸½å…±æœ‰ ${data.total_records} ç­†ç´€éŒ„`;

            } catch (error) {
               console.error('ç²å–ç´€éŒ„å¤±æ•—:', error);
               loadingDiv.innerText = 'ç²å–ç´€éŒ„å¤±æ•—ã€‚';
            } finally {
        loadingDiv.style.display = 'none';
            }
        }

        function renderPagination(totalPages, currentPage) {
            const container = document.getElementById('pagination-controls');
            container.innerHTML = '';
            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.className = 'pagination-btn';
            prevButton.textContent = 'Â« ä¸Šä¸€é ';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => fetchRecords(currentPage - 1));
            container.appendChild(prevButton);

            const pageInfo = document.createElement('span');
            pageInfo.id = 'page-info';
            pageInfo.textContent = `ç¬¬ ${currentPage} / ${totalPages} é `;
            container.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.className = 'pagination-btn';
            nextButton.textContent = 'ä¸‹ä¸€é  Â»';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => fetchRecords(currentPage + 1));
            container.appendChild(nextButton);
        }
        
        function renderTable(records, searchTerm = "") {
            const tableBody = document.getElementById('recordTableBody');
            tableBody.innerHTML = '';
			const regex = searchTerm ? new RegExp(`(${escapeRegex(searchTerm)})`, 'gi') : null;
            records.forEach(record => {
                const row = tableBody.insertRow();
				let contentHtml = escapeHtml(record.content.substring(0, 150)) + (record.content.length > 150 ? '...' : '');			
                let sourceText = record.metadata.source;
                if (sourceText === 'conversation' && record.metadata.timestamp) {
                    sourceText = `æ­·å²å°è©± (${record.metadata.timestamp})`;
                } else {
                    sourceText = sourceText.split(/[\\/]/).pop();
                }
                if (regex) {
                    contentHtml = contentHtml.replace(regex, `<mark>$1</mark>`);
                }				
                row.innerHTML = `<td>...</td>
                         <td>${contentHtml}</td>
                         <td>${escapeHtml(sourceText)}</td>
                         <td><button class="delete-btn" data-id="${escapeHtml(record.id)}">åˆªé™¤</button></td>`;
            });
            document.querySelectorAll('.delete-btn').forEach(button => button.addEventListener('click', handleDelete));
        }
		function escapeRegex(string) {
           return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
        }
        async function handleDelete(event) {
            const docId = event.target.dataset.id;
            if (confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ ID ç‚º "${docId}" çš„é€™ç­†ç´€éŒ„å—ï¼Ÿ`)) {
                try {
                    const response = await fetch('/api/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: docId }) });
                    const result = await response.json();
                    if (result.success) {
                        alert('åˆªé™¤æˆåŠŸï¼');
                        fetchRecords(currentPage);
                    } else { alert('åˆªé™¤å¤±æ•—: ' + result.error); }
                } catch (error) {
                    alert('åˆªé™¤è«‹æ±‚å¤±æ•—ã€‚');
                }
            }
        }
        
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&#039;');
        }
    </script>
</body>
</html>
