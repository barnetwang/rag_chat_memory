<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深度研究報告生成器</title>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #181818;
            --primary-text: #e8e8e8;
            --secondary-text: #a0a0a0;
            --surface-color: #212121;
            --border-color: #333;
            --accent-color: #0071e3;
            --accent-hover: #0077ed;
            --danger-color: #e53935;
            --danger-hover: #c62828;
            --success-color: #4CAF50;
            --info-color: #2196F3;
            --card-shadow: rgba(0, 0, 0, 0.2) 0px 5px 15px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        .light-mode {
            --bg-color: #f7f7f7;
            --primary-text: #1d1d1f;
            --secondary-text: #515154;
            --surface-color: #ffffff;
            --border-color: #e5e5e5;
            --accent-color: #0071e3;
            --accent-hover: #0077ed;
            --danger-color: #d70015;
            --danger-hover: #c30013;
            --success-color: #28a745;
            --info-color: #17a2b8;
            --card-shadow: rgba(0, 0, 0, 0.08) 0px 5px 15px;
        }

        /* --- Global Light Mode Styles --- */
        .light-mode h1, .light-mode h2, .light-mode h3, .light-mode h4, .light-mode h5, .light-mode h6, .light-mode p, .light-mode label, .light-mode .toggle-text, .light-mode .history-title { color: var(--primary-text); }
        .light-mode #app-logo { filter: none; }
        .light-mode #model-selector, .light-mode #chat-input, .light-mode .search-box { background-color: #f0f0f0; color: var(--primary-text); border-color: var(--border-color); }
        .light-mode #model-selector:focus, .light-mode #chat-input:focus, .light-mode .search-box:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2); }
        .light-mode .bot-message .content { background-color: #e9e9eb; color: var(--primary-text); }
        .light-mode th { background-color: #f9f9f9; }
        .light-mode .bot-message .content pre { background-color: #f0f0f0; }
        .light-mode .bot-message .content code { background-color: rgba(0, 0, 0, 0.08); }

        /* --- Base Styles --- */
        body {
            font-family: var(--font-family);
            font-size: 16px;
            line-height: 1.6;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--primary-text);
            transition: background-color 0.3s, color 0.3s;
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 2.5rem; }
        .logo-container { text-align: left; margin-bottom: 2.5rem; }
        #app-logo { max-height: 300px; width: auto; transition: filter 0.3s ease-in-out; }
        
        /* --- Layout --- */
        .main-layout { display: flex; gap: 2.5rem; align-items: flex-start; }
        .left-panel { flex: 3; display: flex; flex-direction: column; min-width: 0; }
        .right-panel { flex: 1; min-width: 350px; position: sticky; top: 2.5rem; }

        /* --- Panel & Card Styles --- */
        .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 0 0.5rem; margin-bottom: 1.5rem; }
        .card { background-color: var(--surface-color); border-radius: 12px; margin-bottom: 2rem; border: 1px solid var(--border-color); overflow: hidden; box-shadow: var(--card-shadow); transition: all 0.3s ease; }
        .card-header { padding: 1rem 1.5rem; background-color: rgba(255, 255, 255, 0.03); border-bottom: 1px solid var(--border-color); font-size: 1.1em; font-weight: 600; margin: 0; }
        .card-body { padding: 1.5rem; }
        .card-body.no-padding { padding: 0; }

        /* --- Chat Area --- */
        #chat-container { display: flex; flex-direction: column; height: 75vh; background-color: var(--surface-color); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); box-shadow: var(--card-shadow); }
        #chat-box { flex-grow: 1; padding: 1.5rem; overflow-y: auto; }
        #chat-form { display: flex; padding: 1rem; border-top: 1px solid var(--border-color); gap: 1rem; align-items: center; }
        #chat-input { flex-grow: 1; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-color); color: var(--primary-text); font-size: 1rem; resize: none; max-height: 150px; overflow-y: auto; transition: all 0.2s ease; }
        #chat-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-hover); outline: none; }
        
        /* --- Messages --- */
        .message { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .message::before { content: ''; display: block; width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; font-weight: bold; text-align: center; line-height: 36px; font-size: 1em; }
        .bot-message::before { background-color: var(--accent-color); content: 'AI'; }
        .user-message { flex-direction: row-reverse; }
        .user-message::before { background-color: #4a4a4a; content: 'U'; }
        .message-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .user-message .message-wrapper { align-items: flex-end; }
        .bot-message .message-wrapper { align-items: flex-start; }
        .message .content { padding: 0.75rem 1.25rem; border-radius: 18px; line-height: 1.6; }
        .user-message .content { background-color: var(--accent-color); color: white; white-space: pre-wrap; word-wrap: break-word; }
        .bot-message .content { background-color: #363636; color: var(--primary-text); font-size: 1.05em; overflow-wrap: break-word; word-break: break-all; }
        
        /* --- Formatted Content (Markdown) --- */
        .bot-message .content h1, .bot-message .content h2, .bot-message .content h3 { margin-top: 1.2em; margin-bottom: 0.6em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.4em; }
        .bot-message .content ul, .bot-message .content ol { padding-left: 2em; }
        .bot-message .content pre { background-color: rgba(0, 0, 0, 0.3); padding: 1em; border-radius: 8px; white-space: pre-wrap; overflow-x: auto; }
        .bot-message .content code { background-color: rgba(255, 255, 255, 0.1); padding: 2px 4px; border-radius: 4px; font-family: monospace; word-break: break-all; }
        .bot-message .content table { width: 100%; border-collapse: collapse; margin: 1em 0; }
        .bot-message .content th, .bot-message .content td { border: 1px solid var(--border-color); padding: 8px; }
        .bot-message .content th { background-color: rgba(255, 255, 255, 0.1); }
        
        /* --- Apple Style Buttons --- */
        .apple-btn { display: inline-flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: 500; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease; padding: 8px 16px; text-decoration: none; white-space: nowrap; }
        .apple-btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .apple-btn.primary { background-color: var(--accent-color); color: white; }
        .apple-btn.primary:hover:not(:disabled) { background-color: var(--accent-hover); transform: translateY(-1px); }
        .apple-btn.secondary { background-color: var(--surface-color); color: var(--primary-text); border: 1px solid var(--border-color); }
        .apple-btn.secondary:hover:not(:disabled) { background-color: rgba(255, 255, 255, 0.05); border-color: var(--accent-color); }
        .apple-btn.danger { background-color: var(--danger-color); color: white; }
        .apple-btn.danger:hover:not(:disabled) { background-color: var(--danger-hover); }
        .apple-btn.icon-btn { padding: 0; width: 44px; height: 44px; }
        #chat-submit.apple-btn.icon-btn { border-radius: 8px; }
        .light-mode .apple-btn.secondary { background-color: #e9e9eb; border-color: #c5c5c7; }
        .light-mode .apple-btn.secondary:hover:not(:disabled) { background-color: #dcdce0; }

        .message-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; padding: 0 0.5rem; }
        
        /* --- Progress Bar & Animation --- */
        .progress-container { display: none; width: 100%; padding: 1rem 0; margin-bottom: 1rem; }
        .progress-steps { display: flex; justify-content: space-between; align-items: center; list-style: none; padding: 0; margin: 0; position: relative; }
        .progress-steps::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 4px; background-color: var(--border-color); transform: translateY(-50%); z-index: 1; }
        .progress-bar-line { position: absolute; top: 50%; left: 0; height: 4px; background-color: var(--accent-color); transform: translateY(-50%); z-index: 2; width: 0%; transition: width 0.4s ease-in-out; }
        .progress-step { position: relative; z-index: 3; text-align: center; }
        .step-circle { width: 30px; height: 30px; border-radius: 50%; background-color: var(--border-color); border: 3px solid var(--surface-color); color: var(--secondary-text); display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.4s ease; margin: 0 auto; }
        .step-label { margin-top: 0.5rem; font-size: 0.8em; color: var(--secondary-text); transition: all 0.4s ease; }
        .progress-step.active .step-circle { background-color: var(--accent-color); color: white; }
        .progress-step.active .step-label { color: var(--accent-color); font-weight: bold; }
        .progress-step.completed .step-circle { background-color: var(--success-color); color: white; }
        .progress-step.completed .step-circle::before { content: '✓'; }
        .progress-status-text { text-align: center; margin-top: 0.5rem; font-size: 0.9em; color: var(--secondary-text); height: 1.2em; }
        .loading-dots { display: none; margin-left: 8px; }
        .progress-step.active .loading-dots { display: inline-flex; }
        .loading-dots span { display: inline-block; width: 5px; height: 5px; margin: 0 1px; background-color: var(--accent-color); border-radius: 50%; animation: bounce-dots 1.4s infinite ease-in-out both; }
        .loading-dots span:nth-of-type(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-of-type(2) { animation-delay: -0.16s; }
        @keyframes bounce-dots { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        /* --- Right Panel & History --- */
        .panel-tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 1.5rem; }
        .panel-tab-button { padding: 0.8rem 1rem; cursor: pointer; background: none; border: none; color: var(--secondary-text); font-size: 1rem; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s ease; }
        .panel-tab-button.active, .panel-tab-button:hover { color: var(--accent-color); border-bottom-color: var(--accent-color); font-weight: 600; }
        .panel-tab-content { display: none; }
        .panel-tab-content.active { display: block; }
        #history-list-container { max-height: 70vh; overflow-y: auto; padding: 0.5rem; }
        .history-item { padding: 1rem; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; border-radius: 8px; margin: 0.5rem; }
        .history-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .history-title { font-weight: 500; color: var(--primary-text); margin: 0 0 0.5rem 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-meta { display: flex; justify-content: space-between; align-items: center; }
        .history-timestamp { font-size: 0.8em; color: var(--secondary-text); }
        .history-actions button { background: none; border: none; padding: 0.25rem; }
        .delete-history-btn svg { stroke: var(--danger-color); cursor: pointer; }
        .no-history { text-align: center; padding: 2rem; color: var(--secondary-text); }

        /* --- Blueprint Approval UI --- */
        .blueprint-container { border: 1px solid var(--border-color); border-radius: 8px; margin-top: 1rem; }
        .blueprint-header { padding: 0.75rem 1rem; font-weight: 600; background-color: rgba(255, 255, 255, 0.05); border-bottom: 1px solid var(--border-color); }
        .blueprint-content { padding: 1rem; max-height: 300px; overflow-y: auto; background-color: rgba(0,0,0,0.2); }
        .blueprint-actions { padding: 0.75rem 1rem; display: flex; gap: 1rem; border-top: 1px solid var(--border-color); }

        /* --- Collapsible References Styles --- */
        .bot-message .content details.references { border: 1px solid var(--border-color); border-radius: 6px; margin-top: 1.5em; overflow: hidden; }
        .bot-message .content summary.references-summary { cursor: pointer; padding: 0.75rem 1rem; font-weight: 600; background-color: rgba(255, 255, 255, 0.05); transition: background-color 0.2s; outline: none; list-style: none; }
        .bot-message .content summary.references-summary::-webkit-details-marker { display: none; }
        .bot-message .content summary.references-summary::before { content: '▶'; margin-right: 0.5em; display: inline-block; transition: transform 0.2s; }
        .bot-message .content details[open] > summary.references-summary::before { transform: rotate(90deg); }
        .bot-message .content summary.references-summary:hover { background-color: rgba(255, 255, 255, 0.1); }
        .bot-message .content details[open] > summary.references-summary { border-bottom: 1px solid var(--border-color); }
        .bot-message .content .reference-content { padding: 0.25rem 1rem 1rem 1rem; }

        /* --- Animated Toggle Switch --- */
        .toggle-switch-container { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; }
        .toggle-text { font-weight: 500; margin-right: 1rem; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--success-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .light-mode .slider { background-color: #ccc; }

        /* --- Responsive Design --- */
        @media (max-width: 992px) {
            .main-layout {
                flex-direction: column;
                gap: 2rem;
            }
            .right-panel {
                position: static;
                min-width: 100%;
                top: auto;
            }
            .container {
                padding: 1.5rem;
            }
            #chat-container {
                height: 60vh;
            }
        }

        @media (max-width: 576px) {
            .container {
                padding: 1rem;
            }
            h2 { font-size: 1.5rem; }
            .panel-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            #chat-box { padding: 1rem; }
        }

    </style>
</head>

<body>
    <button id="theme-toggle" class="apple-btn secondary" onclick="toggleTheme()" style="position: absolute; top: 1rem; right: 1rem; z-index: 100;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
    </button>
    <div class="container">
        <div class="logo-container">
            <a href="/"><img src="/static/logo.png" alt="Logo" id="app-logo"></a>
        </div>
        <div class="main-layout">
            <div class="left-panel">
                <div class="panel-header">
                    <h2>對話視窗</h2>
                    <button id="clear-chat-btn" class="apple-btn secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        <span style="margin-left: 8px;">清除對話</span>
                    </button>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="progress-container" id="progress-container" style="flex-grow: 1;">
                        <ul class="progress-steps" id="progress-steps">
                            <div class="progress-bar-line" id="progress-bar-line"></div>
                            <li class="progress-step" data-step="1"><div class="step-circle">1</div><div class="step-label">拆解任務 <span class="loading-dots"><span></span><span></span><span></span></span></div></li>
                            <li class="progress-step" data-step="2"><div class="step-circle">2</div><div class="step-label">深度研究 <span class="loading-dots"><span></span><span></span><span></span></span></div></li>
                            <li class="progress-step" data-step="3"><div class="step-circle">3</div><div class="step-label">生成大綱 <span class="loading-dots"><span></span><span></span><span></span></span></div></li>
                            <li class="progress-step" data-step="4"><div class="step-circle">4</div><div class="step-label">撰寫報告 <span class="loading-dots"><span></span><span></span><span></span></span></div></li>
                        </ul>
                        <div class="progress-status-text" id="progress-status-text"></div>
                    </div>
                    <button id="cancel-task-btn" class="apple-btn danger" style="display: none; margin-bottom: 1rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                        <span style="margin-left: 8px;">停止</span>
                    </button>
                </div>
                <div id="chat-container">
                    <div id="chat-box">
                        <div class="message bot-message">
                            <div class="message-wrapper">
                                <div class="content">你好！我是您的 深度研究 助理。請提出一個複雜的研究主題來開始。 ---AI 可能會出錯請查核重要資訊---</div>
                                <div class="message-actions"></div>
                            </div>
                        </div>
                    </div>
                    <div id="chat-form">
                        <textarea id="chat-input" placeholder="請在此處輸入您的研究主題... (Shift+Enter 換行)" rows="1" onkeydown="handleEnter(event)"></textarea>
                        <button type="button" id="chat-submit" class="apple-btn primary icon-btn" onclick="sendMessage()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="right-panel">
                <div class="panel-tabs">
                    <button class="panel-tab-button active" onclick="openPanelTab(event, 'settings')">設定</button>
                    <button class="panel-tab-button" onclick="openPanelTab(event, 'history')">歷史紀錄</button>
                </div>
                <div id="settings" class="panel-tab-content active">
                    <div class="card">
                        <h3 class="card-header">模型與功能</h3>
                        <div class="card-body">
                            <label for="model-selector">選取模型:</label>
                            <select id="model-selector"><option value="">正在載入...</option></select>
                            <span id="model-status"></span>
                        </div>
                        <div class="card-body">
                            <div class="toggle-switch-container">
                                <span class="toggle-text">啟用網路研究</span>
                                <label class="switch">
                                    <input type="checkbox" id="web-search-toggle" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="history" class="panel-tab-content">
                    <div class="card">
                        <h3 class="card-header">專案歷史</h3>
                        <div class="card-body no-padding" id="history-list-container">
                            <div class="no-history">正在載入歷史紀錄...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Vars ---
        let chatBox, chatInput, submitButton, modelSelector, modelStatus, clearChatBtn, webSearchToggle;
        let fullMarkdownResponse = '', currentTaskId = null, originalBroadQuestion = null;

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            chatBox = document.getElementById('chat-box'); chatInput = document.getElementById('chat-input'); submitButton = document.getElementById('chat-submit'); modelSelector = document.getElementById('model-selector'); modelStatus = document.getElementById('model-status'); clearChatBtn = document.getElementById('clear-chat-btn'); webSearchToggle = document.getElementById('web-search-toggle');
            webSearchToggle.addEventListener('change', (e) => handleToggleChange(e.target, '/api/set_web_search'));
            modelSelector.addEventListener('change', handleModelChange);
            clearChatBtn.addEventListener('click', handleClearChat);
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });
            loadModelsAndSettings(); loadHistoryList();
        });
        
        // --- Collapsible References ---
        function makeReferencesCollapsible(botContentDiv) {
            if (botContentDiv.querySelector('details.references')) return;
            const h2s = botContentDiv.querySelectorAll('h2');
            h2s.forEach(h2 => {
                if (h2.textContent.includes('參考文獻')) {
                    const details = document.createElement('details'); details.className = 'references';
                    const summary = document.createElement('summary'); summary.className = 'references-summary';
                    summary.textContent = h2.textContent;
                    const contentWrapper = document.createElement('div'); contentWrapper.className = 'reference-content';
                    let sibling = h2.nextElementSibling;
                    while (sibling) { contentWrapper.appendChild(sibling); sibling = h2.nextElementSibling; }
                    details.appendChild(summary); details.appendChild(contentWrapper);
                    h2.parentNode.replaceChild(details, h2);
                }
            });
        }
        
        // --- UI & History Functions ---
        function openPanelTab(evt, tabName) {
            document.querySelectorAll(".panel-tab-content").forEach(tc => tc.style.display = "none");
            document.querySelectorAll(".panel-tab-button").forEach(tb => tb.classList.remove("active"));
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
            if (tabName === 'history') { loadHistoryList(); }
        }
        async function loadHistoryList() {
            const container = document.getElementById('history-list-container');
            container.innerHTML = '<div class="no-history">正在載入...</div>';
            try {
                const response = await fetch('/api/history');
                const historyData = await response.json();
                renderHistoryList(historyData);
            } catch (error) { console.error("載入歷史紀錄失敗:", error); container.innerHTML = '<div class="no-history">載入失敗</div>'; }
        }
        function renderHistoryList(historyData) {
            const container = document.getElementById('history-list-container');
            if (!historyData || historyData.length === 0) { container.innerHTML = '<div class="no-history">目前沒有歷史紀錄</div>'; return; }
            container.innerHTML = '';
            historyData.forEach(entry => {
                const item = document.createElement('div'); item.className = 'history-item';
                item.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--secondary-text)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0;"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                        <div style="flex-grow: 1; overflow: hidden;">
                            <p class="history-title" title="${escapeHtml(entry.title)}">${escapeHtml(entry.title)}</p>
                            <div class="history-meta">
                                <span class="history-timestamp">${new Date(entry.timestamp).toLocaleString()}</span>
                                <div class="history-actions">
                                    <button class="delete-history-btn" title="刪除"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                const clickableArea = item.querySelector('.history-title');
                clickableArea.addEventListener('click', () => viewHistoryEntry(entry.id));
                item.querySelector('.delete-history-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteHistoryEntry(entry.id, entry.title); });
                container.appendChild(item);
            });
        }
        async function viewHistoryEntry(entryId) {
            try {
                const response = await fetch(`/api/history/${entryId}`);
                const entry = await response.json();
                appendMessage(entry.title, 'user');
                const { contentDiv, actionsDiv } = appendMessage('', 'bot');
                contentDiv.innerHTML = marked.parse(entry.report);
                makeReferencesCollapsible(contentDiv);
                const downloadButton = document.createElement('button');
                downloadButton.className = 'apple-btn secondary';
                downloadButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg><span style="margin-left: 8px;">下載報告 (.md)</span>`;
                downloadButton.onclick = () => downloadReport(entry.report, 'md');
                actionsDiv.appendChild(downloadButton);
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) { console.error(`查看歷史紀錄 ${entryId} 失敗:`, error); alert("無法載入該歷史報告。"); }
        }
        async function deleteHistoryEntry(entryId, entryTitle) {
            if (confirm(`您確定要刪除「${entryTitle}」這份報告嗎？`)) {
                try { await fetch(`/api/history/${entryId}`, { method: 'DELETE' }); loadHistoryList(); } 
                catch (error) { console.error(`刪除歷史紀錄 ${entryId} 失敗:`, error); alert("刪除失敗。"); }
            }
        }
        async function saveReportToHistory(title, report) {
            try {
                const response = await fetch('/api/history', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: title, report: report }) });
                if (response.ok && document.getElementById('history').style.display === 'block') { loadHistoryList(); }
            } catch (error) { console.error("儲存歷史紀錄失敗:", error); }
        }

        function handleBlueprintApproval(botContentDiv, blueprintData) {
            const blueprint = blueprintData.blueprint;
            const duration = blueprintData.duration;
            botContentDiv.innerHTML = `
                <div class="blueprint-container">
                    <div class="blueprint-header">報告大綱已生成 (研究階段耗時: ${escapeHtml(duration)})</div>
                    <div class="blueprint-content"><pre><code>${escapeHtml(JSON.stringify(blueprint, null, 2))}</code></pre></div>
                    <div class="blueprint-actions"><button id="confirm-blueprint-btn" class="apple-btn primary">確認並繼續撰寫</button></div>
                </div>`;
            
            document.getElementById('confirm-blueprint-btn').onclick = () => {
                document.getElementById('confirm-blueprint-btn').disabled = true;
                document.getElementById('confirm-blueprint-btn').textContent = '處理中...';
                continueWritingReport(botContentDiv);
            };
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function continueWritingReport(botContentDiv) {
            botContentDiv.innerHTML = ''; 
            fullMarkdownResponse = '';
            
            const progressContainer = document.getElementById('progress-container');
            progressContainer.style.display = 'block';
            updateProgress(4, '步驟 4/4: 正在撰寫最終報告...');
            
            const actionsDiv = botContentDiv.closest('.message-wrapper').querySelector('.message-actions');
            let animationFrameId = null;

            const render = () => {
                botContentDiv.innerHTML = marked.parse(fullMarkdownResponse);
                if (botContentDiv.innerHTML) { 
                    chatBox.scrollTop = chatBox.scrollHeight; 
                }
                animationFrameId = null;
            };

            const finalizeUIAndRender = (isSuccess = true) => {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                render();
                makeReferencesCollapsible(botContentDiv);
                progressContainer.style.display = 'none';
                document.getElementById('cancel-task-btn').style.display = 'none';
                submitButton.disabled = false;
                
                if (isSuccess && fullMarkdownResponse.trim().length > 0) {
                    const downloadButton = document.createElement('button');
                    downloadButton.className = 'apple-btn secondary';
                    downloadButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg><span style="margin-left: 8px;">下載報告 (.md)</span>`;
                    downloadButton.onclick = () => downloadReport(fullMarkdownResponse, 'md');
                    actionsDiv.innerHTML = ''; 
                    actionsDiv.appendChild(downloadButton);
                }
                currentTaskId = null;
            };

            const appendError = (message) => {
                botContentDiv.innerHTML = `<p style="color:var(--danger-color);">[錯誤]：${message}</p>`;
                finalizeUIAndRender(false);
            };

            try {
                const url = `/api/write_report?task_id=${currentTaskId}`;

                const eventSource = new EventSource(url);

                eventSource.onmessage = function(event) {
                    let eventData;
                    try { 
                        eventData = JSON.parse(event.data); 
                    } catch (e) { 
                        console.error("Failed to parse event data: ", event.data);
                        return; 
                    }

                    switch(eventData.type) {
                        case 'status':
                            updateProgress(4, eventData.message);
                            break;
                        case 'content':
                            fullMarkdownResponse += eventData.content;
                            if (!animationFrameId) {
                                animationFrameId = requestAnimationFrame(render);
                            }
                            break;
                        case 'error':
                            appendError(eventData.content);
                            eventSource.close();
                            break;
                        case 'done':
                            finalizeUIAndRender(true);
                            eventSource.close();
                            break;
                    }
                };

                eventSource.onerror = function(err) {
                    console.error("EventSource failed:", err);
                    if (!fullMarkdownResponse) {
                         appendError("與伺服器的連線意外中斷。");
                    }
                    finalizeUIAndRender(false); 
                    eventSource.close();
                };

            } catch (error) {
                appendError("撰寫報告失敗：" + error.toString());
            }
        }
        
        // --- Core Logic ---
        function updateProgress(step, message = '') {
            const steps = document.querySelectorAll('.progress-step');
            const progressBarLine = document.getElementById('progress-bar-line');
            steps.forEach(s => { s.classList.remove('active', 'completed'); const loadingDots = s.querySelector('.loading-dots'); if(loadingDots) loadingDots.style.display = 'none'; if (parseInt(s.dataset.step) < step) { s.classList.add('completed'); } else if (parseInt(s.dataset.step) === step) { s.classList.add('active'); if(loadingDots) loadingDots.style.display = 'inline-flex'; } });
            progressBarLine.style.width = `${step > 1 ? ((step - 1) / (steps.length - 1)) * 100 : 0}%`;
            document.getElementById('progress-status-text').textContent = message;
        }
        function appendMessage(text, sender) {
            const messageDiv = document.createElement('div'); messageDiv.className = `message ${sender}-message`;
            const messageWrapper = document.createElement('div'); messageWrapper.className = 'message-wrapper';
            const contentDiv = document.createElement('div'); contentDiv.className = 'content';
            if (sender === 'user') { contentDiv.textContent = text; }
            const actionsDiv = document.createElement('div'); actionsDiv.className = 'message-actions';
            messageWrapper.appendChild(contentDiv); messageWrapper.appendChild(actionsDiv);
            messageDiv.appendChild(messageWrapper); chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return { contentDiv, actionsDiv }; 
        }
        async function sendMessage() {
            const question = chatInput.value.trim(); if (!question) return;
            submitButton.disabled = true;
            originalBroadQuestion = question;
            appendMessage(question, 'user');
            chatInput.value = ''; chatInput.style.height = 'auto';
            const { contentDiv, actionsDiv } = appendMessage('', 'bot');
            
            executeBlueprintGeneration(question, contentDiv, actionsDiv, false);
        }

        async function executeBlueprintGeneration(question, botContentDiv, actionsDiv, bypassAssessment) {
            submitButton.disabled = true;
            currentTaskId = `task_${Date.now()}`;
            
            const cancelBtn = document.getElementById('cancel-task-btn');
            const progressContainer = document.getElementById('progress-container');
            
            cancelBtn.style.display = 'flex';
            cancelBtn.onclick = () => {
                cancelBtn.disabled = true;
                cancelTask(currentTaskId);
            };
            progressContainer.style.display = 'block';
            updateProgress(1, bypassAssessment ? '正在處理...' : '正在評估問題...');
            
            const appendError = (message) => {
                botContentDiv.innerHTML = `<p style="color:var(--danger-color);">[錯誤]：${message}</p>`;
                progressContainer.style.display = 'none';
                cancelBtn.style.display = 'none';
                submitButton.disabled = false;
            };

            try {
                const url = `/ask?question=${encodeURIComponent(question)}&task_id=${currentTaskId}&bypass_assessment=${bypassAssessment}`;
                const eventSource = new EventSource(url);

                eventSource.onmessage = function(event) { 
                    let eventData; try { eventData = JSON.parse(event.data); } catch (e) { return; }

                    switch(eventData.type) {
                        case 'clarification':
                            handleClarification(botContentDiv, eventData.data);
                            progressContainer.style.display = 'none';
                            cancelBtn.style.display = 'none';
                            submitButton.disabled = false;
                            eventSource.close();
                            break;
                        case 'blueprint_generated':
                            handleBlueprintApproval(botContentDiv, eventData.data);
                            eventSource.close();
                            break;
                        case 'status':
                            const match = eventData.message.match(/步驟\s*(\d)/);
                            if (match) { updateProgress(parseInt(match[1]), eventData.message); }
                            break;
                        case 'content':
                            fullMarkdownResponse += eventData.content;
                            botContentDiv.innerHTML = marked.parse(fullMarkdownResponse);
                            break;
                        case 'error':
                            appendError(eventData.content);
                            eventSource.close();
                            break;
                        case 'done':
                            if (!botContentDiv.querySelector('.blueprint-container')) {
                                progressContainer.style.display = 'none';
                                cancelBtn.style.display = 'none';
                                submitButton.disabled = false;
                            }
                            eventSource.close();
                            break;
                    }
                };

                eventSource.onerror = function(err) {
                    if (!botContentDiv.innerHTML) {
                        appendError("與伺服器的連線意外中斷。");
                    }
                    eventSource.close();
                };
            } catch (error) {
                appendError("建立連線失敗。");
            }
        }
        function handleClarification(botContentDiv, clarificationData) {
            botContentDiv.innerHTML = `<p>${clarificationData.intro_sentence}</p>`;
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'clarification-options';
            optionsContainer.style.display = 'flex';
            optionsContainer.style.flexDirection = 'column';
            optionsContainer.style.gap = '0.5rem';
            optionsContainer.style.marginTop = '1rem';
            clarificationData.options.forEach(optionText => { 
                const button = document.createElement('button'); 
                button.className = 'apple-btn secondary'; 
                button.textContent = optionText; 
                button.onclick = () => handleClarificationChoice(optionText); 
                optionsContainer.appendChild(button); 
            });
            botContentDiv.appendChild(optionsContainer);
        }
        function handleClarificationChoice(choiceText) {
            appendMessage(choiceText, 'user');
            const newClarifiedQuestion = `關於「${originalBroadQuestion}」，請為我 "${choiceText}"`;
            const { contentDiv, actionsDiv } = appendMessage('', 'bot');
            executeBlueprintGeneration(newClarifiedQuestion, contentDiv, actionsDiv, true);
        }
        
        async function loadModelsAndSettings() {
            const statusElement = document.getElementById('model-status');
            const selectorElement = document.getElementById('model-selector');
            
            try {
                statusElement.textContent = '1. Fetching...';
                const response = await fetch('/api/models');
                
                statusElement.textContent = '2. Got response, parsing JSON...';
                const data = await response.json();
                
                statusElement.textContent = '3. Checking response status...';
                if (!response.ok) {
                    throw new Error(data.error || 'Server returned an error');
                }
                
                statusElement.textContent = '4. Clearing old options...';
                selectorElement.innerHTML = '';
                
                statusElement.textContent = '5. Populating new options...';
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = new Option(model, model);
                        if (model === data.current_model) {
                            option.selected = true;
                        }
                        selectorElement.appendChild(option);
                    });
                    statusElement.textContent = `當前: ${data.current_model.split(':')[0]}`;
                } else {
                     statusElement.textContent = "無可用模型";
                     selectorElement.innerHTML = '<option value="">無可用模型</option>';
                }
                
                webSearchToggle.checked = data.web_search_enabled;

            } catch (error) {
                console.error('載入設定失敗:', error);
                statusElement.textContent = `載入失敗: ${error.message}`;
                selectorElement.innerHTML = '<option value="">載入失敗</option>';
                alert(`模型載入失敗：\n${error.message}`);
            }
        }
        function downloadReport(content, format = 'md') {
            const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 10);
            a.href = url; a.download = `KAIZEN-Report-${timestamp}.${format}`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        async function handleToggleChange(toggleElement, apiUrl) { try { await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled: toggleElement.checked }) }); } catch (error) { toggleElement.checked = !toggleElement.checked; } }
        async function handleModelChange(event) {
            const selectedModel = event.target.value; modelStatus.textContent = `切換中...`;
            try {
                const response = await fetch('/api/set_model', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: selectedModel }) });
                if (!response.ok) throw new Error('切換失敗');
                modelStatus.textContent = `當前: ${selectedModel.split(':')[0]} ✅`;
            } catch (error) { modelStatus.textContent = `切換失敗`; }
            setTimeout(() => { modelStatus.textContent = `當前: ${modelSelector.value.split(':')[0]}`; }, 4000);
        }
        function handleClearChat() { if (confirm('您確定要清除目前視窗中的對話嗎？')) { chatBox.innerHTML = `<div class="message bot-message"><div class="message-wrapper"><div class="content">你好！我是您的 KAIZEN 深度研究助理。</div><div class="message-actions"></div></div></div>`; } }
        async function cancelTask(taskId) { if (!taskId) return; try { await fetch('/api/cancel_task', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ task_id: taskId }) }); } catch (error) { console.error('取消任務時出錯:', error); } }
        function handleEnter(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } }
        function escapeHtml(unsafe) { return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function toggleTheme() { document.body.classList.toggle('light-mode'); }
    </script>
</body>
</html>